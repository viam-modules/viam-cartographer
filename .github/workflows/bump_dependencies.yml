name: Bump Versions

concurrency: 
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

on:
#   schedule:
#     - cron: '0 * * * *' # hourly
  workflow_dispatch:
  push:
    branches: [ 'workflows/update-dependencies' ]

jobs:
  bump-versions:
    name: Bump Package Versions
    if: github.repository_owner == 'viamrobotics'
    runs-on: [self-hosted, x64]
    container:
      image: ghcr.io/viamrobotics/canon:amd64
    timeout-minutes: 10

    steps:
    - name: Check out code
      uses: actions/checkout@v3
      with:
        ref: ${{ github.head_ref }}
        token: ${{ secrets.GIT_ACCESS_TOKEN }}

    - name: Update go dependencies
      run: |
        git init
        git add .
        sudo chown -R testbot .
        sudo -u testbot bash -lc 'go get -u .'
        GEN_DIFF=$(git status -s)

        if [ -n "$GEN_DIFF" ]; then
            echo 
            git status
            
        else
            echo "no updates needed"
            exit 1
        fi

    - name: Add + Commit + Open PR
      uses: peter-evans/create-pull-request@v5
      with:
          commit-message: '[WORKFLOW] Updating go dependencies'
          branch: 'workflow/update-dependencies'
          delete-branch: true
          base: main
          title: Automated Go Dependencies Update
          body: This is an auto-generated PR to update go dependencies. Please confirm tests are passing before merging          
